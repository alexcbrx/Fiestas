<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil - {{ usuario }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #0f0f0f;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
    }

    .navbar {
      background: rgba(18, 18, 18, 0.95);
      box-shadow: 0 0 20px #cc079a;
    }

    .navbar .nav-link,
    .navbar .navbar-brand {
      color: #fff !important;
    }

    .fiesta-card {
      background-color: #1c1c1c;
      border-left: 5px solid #ff3366;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 0 15px #ff00cc;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .fiesta-card:hover {
      transform: scale(1.03);
      box-shadow: 0 0 25px #ff00cc;
    }

    .btn-neon {
      background: none;
      border: 2px solid #ff00cc;
      color: #ff66cc;
      transition: all 0.3s;
    }

    .btn-neon:hover {
      background: #ff00cc;
      color: #1a1a1a;
      box-shadow: 0 0 15px #ff66cc;
    }

    .alert-neon {
      background: rgba(255, 0, 204, 0.1);
      border: 2px solid #ff00cc;
      color: #ff66cc;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .profile-card {
      background-color: #1c1c1c;
      border: 2px solid #ff00cc;
      border-radius: 15px;
      box-shadow: 0 0 20px #ff00cc;
      padding: 20px;
      margin-bottom: 20px;
    }

    .modal-content {
      background-color: #111;
      color: #fff;
      border: 2px solid #ff00cc;
    }

    .modal-footer .btn {
      border-width: 2px;
    }

    footer {
      margin-top: 40px;
      border-top: 1px solid #ff00cc;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark py-3">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"> Asistente de Fiestas</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('inicio') }}">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('servicios') }}">Servicios</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('perfil') }}">Perfil</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('chat') }}">Muro de fiestas</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Cerrar Sesi贸n</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Mensajes flash -->
  <div class="container mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-neon alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
  </div>

  <section class="container my-4">
    <!-- Tarjeta de perfil -->
    <div class="profile-card">
      <h2 style="color:#ff66cc;"> Perfil de {{ usuario }}</h2>
      <p>隆Bienvenido de nuevo, <span style="color:#ff000d;">{{ usuario }}</span>! Aqu铆 puedes gestionar tus fiestas y configuraciones.</p>
    </div>

    <!-- Crear fiesta -->
    <section class="container my-4">
      <h2>Crear nueva fiesta</h2>
      <form action="{{ url_for('crear_fiesta') }}" method="POST">
        <div class="row g-3">
          <div class="col-md-6">
            <input type="text" class="form-control" name="nombre" placeholder="Nombre de la fiesta" required>
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="tipo" placeholder="Tipo de fiesta" required>
          </div>
          
          <div class="col-md-6">
            <select name="salon" class="form-select">
              <option value="">Selecciona un sal贸n</option>
              {% for s in salones %}
              <option value="{{ s.id }}">{{ s.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <select name="comida" class="form-select">
              <option value="">Selecciona comida</option>
              {% for c in comidas %}
              <option value="{{ c.id }}">{{ c.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <select name="dj" class="form-select">
              <option value="">Selecciona DJ</option>
              {% for d in djs %}
              <option value="{{ d.id }}">{{ d.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <select name="entretenimiento" class="form-select">
              <option value="">Selecciona entretenimiento</option>
              {% for e in entretenimientos %}
              <option value="{{ e.id }}">{{ e.nombre }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3 btn-neon">Crear Fiesta</button>
      </form>
    </section>

    <!-- Listado de fiestas -->
    <section class="container my-5">
      <h2>Mis Fiestas</h2>
      {% if fiestas %}
      <div class="row row-cols-1 row-cols-md-2 g-4">
        {% for f in fiestas %}
        <div class="col">
          <div class="fiesta-card">
            <h4>{{ f.fiesta_nombre }}</h4>
            <p><strong>Tipo:</strong> {{ f.tipo or '-' }}</p>
            <p><strong>Sal贸n:</strong> {{ f.salon_nombre or '-' }}</p>
            <p><strong>Comida:</strong> {{ f.comida_nombre or '-' }}</p>
            <p><strong>DJ:</strong> {{ f.dj_nombre or '-' }}</p>
            <p><strong>Entretenimiento:</strong> {{ f.entretenimiento_nombre or '-' }}</p>
            <div class="acciones">
              <!-- bot贸n para generar y descargar PDF -->
              <a class="btn btn-sm btn-primary" href="{{ url_for('fiesta_pdf', id=f.id) }}" target="_blank">PDF</a>
              <button type="button" class="btn btn-warning btn-sm btn-neon"
                data-bs-toggle="modal"
                data-bs-target="#editModal"
                data-id="{{ f.id }}"
                data-nombre="{{ f.fiesta_nombre }}"
                data-tipo="{{ f.tipo }}"
                data-salon="{{ f.salon_id }}"
                data-comida="{{ f.comida_id }}"
                data-dj="{{ f.dj_id }}"
                data-entretenimiento="{{ f.entretenimiento_id }}">
                Editar
              </button>

              <button type="button" class="btn btn-danger btn-sm btn-neon" data-bs-toggle="modal"
                data-bs-target="#deleteModal" data-bs-href="{{ url_for('eliminar_fiesta', id=f.id) }}"
                data-bs-nombre="{{ f.fiesta_nombre }}">Eliminar</button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p>No has creado ninguna fiesta todav铆a.</p>
      {% endif %}
    </section>

    <!-- Acciones generales -->
    <div class="acciones-generales" style="margin-bottom:16px;">
      <a class="btn btn-primary" href="{{ url_for('fiestas_pdf') }}" target="_blank">Descargar PDF general</a>
    </div>

    {% for fiesta in fiestas %}
      <div class="fiesta-card">
        <!-- ...otros datos de la fiesta... -->
        <h4>{{ fiesta.nombre }}</h4>
        <p>Tipo: {{ fiesta.tipo }}</p>
        <p>Fecha: {{ fiesta.fecha }}</p>
        <div class="acciones">
          <a class="btn btn-sm btn-primary" href="{{ url_for('fiesta_pdf', id=fiesta['id']) }}" target="_blank">PDF</a>
          <!-- ...otros botones (editar, eliminar) ... -->
        </div>
      </div>
    {% endfor %}
  </section>

  <!-- Modal eliminar -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-header border-0 justify-content-center">
          <h5 class="modal-title">锔 Confirmaci贸n</h5>
        </div>
        <div class="modal-body">
          <p id="deleteModalText">驴Est谩s seguro de eliminar esta fiesta?</p>
        </div>
        <div class="modal-footer justify-content-center border-0">
          <button type="button" class="btn btn-secondary btn-neon" data-bs-dismiss="modal">Cancelar</button>
          <a href="#" class="btn btn-danger btn-neon" id="deleteModalConfirm">Eliminar</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal editar -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title">锔 Editar Fiesta</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="editForm" method="POST">
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label>Nombre</label>
                <input type="text" class="form-control" name="nombre" id="edit-nombre" required>
              </div>
              <div class="col-md-6">
                <label>Tipo</label>
                <input type="text" class="form-control" name="tipo" id="edit-tipo" required>
              </div>
              <div class="col-md-6">
                <label>Sal贸n</label>
                <select name="salon" id="edit-salon" class="form-select">
                  {% for s in salones %}
                  <option value="{{ s.id }}">{{ s.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label>Comida</label>
                <select name="comida" id="edit-comida" class="form-select">
                  {% for c in comidas %}
                  <option value="{{ c.id }}">{{ c.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label>DJ</label>
                <select name="dj" id="edit-dj" class="form-select">
                  {% for d in djs %}
                  <option value="{{ d.id }}">{{ d.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label>Entretenimiento</label>
                <select name="entretenimiento" id="edit-entretenimiento" class="form-select">
                  {% for e in entretenimientos %}
                  <option value="{{ e.id }}">{{ e.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-secondary btn-neon" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary btn-neon">Guardar cambios</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <footer class="text-center py-3">
    &copy; 2025 Asistente de Fiestas. Todos los derechos reservados.
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Modal eliminar
    var deleteModal = document.getElementById('deleteModal')
    deleteModal.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget
      var nombre = button.getAttribute('data-bs-nombre')
      var href = button.getAttribute('data-bs-href')
      deleteModal.querySelector('#deleteModalText').textContent = `驴Est谩s seguro de eliminar "${nombre}"?`
      deleteModal.querySelector('#deleteModalConfirm').setAttribute('href', href)
    })

    // Modal de edici贸n
    var editModal = document.getElementById('editModal')
    editModal.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget
      var id = button.getAttribute('data-id')
      var nombre = button.getAttribute('data-nombre')
      var tipo = button.getAttribute('data-tipo')
      var salon = button.getAttribute('data-salon')
      var comida = button.getAttribute('data-comida')
      var dj = button.getAttribute('data-dj')
      var entretenimiento = button.getAttribute('data-entretenimiento')

      document.getElementById('edit-nombre').value = nombre
      document.getElementById('edit-tipo').value = tipo
      document.getElementById('edit-salon').value = salon
      document.getElementById('edit-comida').value = comida
      document.getElementById('edit-dj').value = dj
      document.getElementById('edit-entretenimiento').value = entretenimiento

      // Cambia din谩micamente la acci贸n del formulario
      document.getElementById('editForm').action = `/editar_fiesta/${id}`
    })

    // Auto-cerrar alertas despu茅s de 5 segundos
    document.querySelectorAll('.alert').forEach(function (alert) {
      setTimeout(function () {
        bootstrap.Alert.getOrCreateInstance(alert).close();
      }, 5000);
    });
  </script>
</body>
</html>
